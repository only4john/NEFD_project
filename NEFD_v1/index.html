<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>National Exotic Forest Description</title>
    <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4.7.0/dist/maplibre-gl.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; min-height: 600px; background: #f0f0f0; }
        #title {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            font-family: Arial, sans-serif;
            font-size: 20px;
            font-weight: bold;
            z-index: 1000;
        }
        #legend {
            position: absolute;
            bottom: 30px;
            right: 10px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            font-family: Arial, sans-serif;
            z-index: 1000;
        }
        .legend-item { display: flex; align-items: center; margin-bottom: 5px; }
        .legend-color {
            width: 20px; height: 20px; margin-right: 5px; display: inline-block;
        }
        #controls {
            position: absolute;
            top: 60px;
            left: 10px;
            background: white;
            padding: 5px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            z-index: 1000;
        }
        #controls select {
            margin: 5px; padding: 5px 10px; cursor: pointer;
            width: 200px; font-size: 14px;
        }
        #zoom-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            z-index: 1000;
        }
        .zoom-button {
            background: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            width: 30px;
            height: 30px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
            transition: background 0.2s;
        }
        .zoom-button:hover { background: #f0f0f0; }
        .popup-chart { width: 200px; height: 100px; }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="title">National Exotic Forest Description 2024</div>
    <div id="legend">
        <h4>Forest Area Ratio (%)</h4>
        <div class="legend-item"><span class="legend-color" style="background: #E8F5E9;"></span>0 - 1%</div>
        <div class="legend-item"><span class="legend-color" style="background: #A5D6A7;"></span>1 - 5%</div>
        <div class="legend-item"><span class="legend-color" style="background: #66BB6A;"></span>5 - 10%</div>
        <div class="legend-item"><span class="legend-color" style="background: #388E3C;"></span>10 - 20%</div>
        <div class="legend-item"><span class="legend-color" style="background: #2E7D32;"></span>20 - 50%</div>
        <div class="legend-item"><span class="legend-color" style="background: #1B5E20;"></span>> 50%</div>
    </div>
    <div id="zoom-controls">
        <button class="zoom-button" onclick="map.zoomIn()">+</button>
        <button class="zoom-button" onclick="map.zoomOut()">âˆ’</button>
    </div>
    <div id="controls">
        <select id="species-select" onchange="updateSpecies()">
            <option value="all_species_view">All Species</option>
            <option value="radiata_pine_view">Radiata Pine</option>
            <option value="cypress_species_view">Cypress Species</option>
            <option value="douglas_fir_view">Douglas Fir</option>
            <option value="eucalypts_view">Eucalypts</option>
            <option value="other_hardwoods_view">Other Hardwoods</option>
            <option value="other_softwoods_view">Other Softwoods</option>
            <option value="radiata_pine_pruned_with_thinning_view">Radiata Pine (Pruned, With Thinning)</option>
            <option value="radiata_pine_pruned_without_thinning_view">Radiata Pine (Pruned, Without Thinning)</option>
            <option value="radiata_pine_unpruned_with_thinning_view">Radiata Pine (Unpruned, With Thinning)</option>
            <option value="radiata_pine_unpruned_without_thinning_view">Radiata Pine (Unpruned, Without Thinning)</option>
        </select>
    </div>

    <script src="https://unpkg.com/maplibre-gl@4.7.0/dist/maplibre-gl.js"></script>
    <script>
        const map = new maplibregl.Map({
            container: 'map',
            style: 'https://basemaps.cartocdn.com/gl/positron-gl-style/style.json',
            center: [174.7762, -41.2865],
            zoom: 5
        });

        function updateSpecies() {
            const species = document.getElementById('species-select').value;
            const layerId = 'forestry-layer';
            const outlineLayerId = 'forestry-outline';
            if (map.getLayer(layerId)) map.removeLayer(layerId);
            if (map.getLayer(outlineLayerId)) map.removeLayer(outlineLayerId);
            if (map.getSource('forestry')) map.removeSource('forestry');
            map.addSource('forestry', {
                type: 'vector',
                tiles: [`http://localhost:7800/public.${species}/{z}/{x}/{y}.pbf`],
                promoteId: 'TA2023_V1_00',
                minzoom: 0,
                maxzoom: 14
            });
            map.addLayer({
                'id': 'forestry-layer',
                'type': 'fill',
                'source': 'forestry',
                'source-layer': `public.${species}`,
                'paint': {
                    'fill-color': [
                        'step',
                        ['/', ['*', ['get', 'total'], 0.01], ['get', 'LAND_AREA_SQ_KM']],
                        '#E8F5E9', 0.01,
                        '#A5D6A7', 0.05,
                        '#66BB6A', 0.10,
                        '#388E3C', 0.20,
                        '#2E7D32', 0.50,
                        '#1B5E20'
                    ],
                    'fill-opacity': 0.7,
                    'fill-outline-color': 'white'
                }
            });
            map.addLayer({
                'id': 'forestry-outline',
                'type': 'line',
                'source': 'forestry',
                'source-layer': `public.${species}`,
                'paint': { 'line-color': 'white', 'line-width': 1 }
            });
        }

        map.on('load', function () {
            updateSpecies();

            map.on('click', 'forestry-layer', function (e) {
                const props = e.features[0].properties;
                const forestRatio = (props.total * 0.01) / props.LAND_AREA_SQ_KM * 100;

                const popupContent = document.createElement('div');
                popupContent.innerHTML = `
                    <b>${props.ta_name || 'Unknown'}</b><br>
                    TA Code: ${props.TA2023_V1_00 || 'N/A'}<br>
                    Land Area: ${props.LAND_AREA_SQ_KM ? Math.round(props.LAND_AREA_SQ_KM) : 'N/A'} sq km<br>
                    Total Forest Area: ${props.total ? Math.round(props.total) : 'N/A'} ha<br>
                    Forest Ratio: ${forestRatio ? forestRatio.toFixed(2) : 'N/A'} %<br>
                    <canvas id="ageHistogram" class="popup-chart"></canvas>
                `;

                const popup = new maplibregl.Popup()
                    .setLngLat(e.lngLat)
                    .setDOMContent(popupContent)
                    .addTo(map);

                const ctx = popupContent.querySelector('#ageHistogram').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['5', '10', '15', '20', '25', '30', '35', '40', '50', '60', '80'],
                        datasets: [{
                            label: 'Area (ha)',
                            data: [
                                props._1_5 || 0, props._6_10 || 0, props._11_15 || 0,
                                props._16_20 || 0, props._21_25 || 0, props._26_30 || 0,
                                props._31_35 || 0, props._36_40 || 0, props._41_50 || 0,
                                props._51_60 || 0, props._61_80 || 0
                            ],
                            backgroundColor: [
                                '#E8F5E9', '#C8E6C9', '#A5D6A7', '#81C784', '#66BB6A',
                                '#4CAF50', '#43A047', '#388E3C', '#2E7D32', '#1B5E20', '#104314'
                            ],
                            borderColor: '#2E7D32',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'Area (ha)', font: { size: 10 } },
                                ticks: { font: { size: 8 } }
                            },
                            x: {
                                title: { display: true, text: 'Age (years)', font: { size: 10 } },
                                ticks: { font: { size: 8 }, rotation: 45 }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: { enabled: true, titleFont: { size: 10 }, bodyFont: { size: 8 } }
                        },
                        responsive: false,
                        maintainAspectRatio: false
                    }
                });
            });

            map.on('mouseenter', 'forestry-layer', () => map.getCanvas().style.cursor = 'pointer');
            map.on('mouseleave', 'forestry-layer', () => map.getCanvas().style.cursor = '');
        });
    </script>
</body>
</html>
